# Example Harvest ems alerts

groups:
  - name: Harvest Ems Alert
    rules:

      # Alert for Anti-ransomware state change ems
      - alert: Anti-ransomware state was changed volume
        expr: last_over_time(ems_events{message="arw.volume.state"} [15m] ) == 1
        labels:
          severity: "error"
        annotations:
          summary: "Anti-ransomware state was changed to [{{ $labels.op }}] for Volume uuid [{{ $labels.volumeuuid }}]."
          description: "Anti-ransomware state was changed to [{{ $labels.op }}] for Volume uuid [{{ $labels.volumeuuid }}]."

      # Alert for Anti-ransomware state change ems
      - alert: Anti-ransomware state was changed svm
        expr: last_over_time(ems_events{message="arw.vserver.state"} [15m] ) == 1
        labels:
          severity: "error"
        annotations:
          summary: "Anti-ransomware state was changed to [{{ $labels.op }}] for SVM name [{{ $labels.vserverName }}]."
          description: "Anti-ransomware state was changed to [{{ $labels.op }}] for SVM name [{{ $labels.vserverName }}]."

      # Alert for Call-home arw message ems
      - alert: Call-home arw message received
        expr: last_over_time(ems_events{message="callhome.arw.activity.seen"} [15m] ) == 1
        labels:
          severity: "error"
        annotations:
          summary: "Call-home arw message for Volume uuid [{{ $labels.volume_uuid }}]."
          description: "Call-home arw message for Volume uuid [{{ $labels.volume_uuid }}]."

      # Alert for Call-home battery low bookend ems - will be resolved by nvram battery charging normal
      - alert: Call-home battery low message received
        expr: (max by(node_uuid) (last_over_time(timestamp(ems_events{message="callhome.battery.low"})[30m:])) - max by(node_uuid) (last_over_time(timestamp(ems_events{message="nvram.battery.charging.normal"})[30m:])) or group by (node_uuid) (last_over_time(timestamp(ems_events{message="callhome.battery.low"})[30m:]) unless on (node_uuid) last_over_time(timestamp(ems_events{message="nvram.battery.charging.normal"})[30m:]))) > 0
        labels:
          severity: "error"
        annotations:
          summary: "Call home BATTERY_LOW message for Node uuid [{{ $labels.node_uuid }}]."
          description: "Call home BATTERY_LOW message for Node uuid [{{ $labels.node_uuid }}]."

      # Alert for Call-home hainterconnect down ems
      - alert: Call-home ha interconnect message received
        expr: last_over_time(ems_events{message="callhome.hainterconnect.down"} [15m] ) == 1
        labels:
          severity: "error"
        annotations:
          summary: "Call-home ha interconnect message for Node uuid [{{ $labels.node_uuid }}]."
          description: "Call-home ha interconnect message for Node uuid [{{ $labels.node_uuid }}]."
